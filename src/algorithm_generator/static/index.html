<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Infinity | OMEGA Arena</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&display=swap" rel="stylesheet">
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <link rel="icon" type="image/x-icon" href="/static/infinity_icon.png">
  <style>
    body { font-family: 'Crimson Pro', serif; background-color: #F8F7F2; }
    .gold-bg { background-color: #D4AF37; }
    .gold-text { color: #D4AF37; }
    .equation-box { background: rgba(212, 175, 55, 0.03); border: 1px dashed rgba(212, 175, 55, 0.3); }
    .summary-text { font-style: italic; line-height: 1.4; animation: fadeIn 0.4s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(2px); } to { opacity: 1; transform: translateY(0); } }
    .mjx-container { overflow-x: auto; overflow-y: hidden; max-width: 100%; }
    .perspective-1000 { perspective: 1000px; }
    .card-inner { transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-flipped .card-inner { transform: rotateY(180deg); }
    .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
    .card-back { transform: rotateY(180deg); top: 0; left: 0; }
  </style>
</head>

<body class="text-gray-800 pb-10 md:pb-20">
  <nav class="bg-white/80 backdrop-blur-md border-b border-gray-100 w-full fixed top-0 z-50">
    <div class="max-w-5xl mx-auto px-4 md:px-6 py-4 md:py-6 flex justify-between items-center">
        <a href="/" class="flex items-center">
            <img src="/static/infinity_logo.png" alt="INFINITY" class="h-12 md:h-16 w-auto object-contain transition-transform">
        </a>
      <div class="flex items-center space-x-4 md:space-x-8 text-[10px] md:text-[12px] uppercase tracking-[0.15em] md:tracking-[0.25em] font-bold text-gray-400">
        <a href="/docs" class="hover:text-black transition-colors hidden sm:block">API Docs</a>
        <button id="authBtn" onclick="handleAuth()" class="hover:text-black transition-colors sm:border-l sm:pl-8 border-gray-100 uppercase">Login</button>
      </div>
    </div>
  </nav>

  <div class="h-24 md:h-32"></div>

  <main class="max-w-4xl mx-auto px-4 md:px-6">
    <div class="text-center mb-8 md:mb-10">
      <h1 id="mainHeader" class="text-3xl md:text-5xl mb-3 md:mb-4 font-light text-gray-900 leading-tight">Make your own ML Model.</h1>
      <p class="text-gray-400 italic text-base md:text-lg text-balance px-4">Every generation is benchmarked against the global leaderboard.</p>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-5 md:p-8 border border-gray-100 mb-6 md:mb-8">
      <textarea id="prompt" rows="3" class="w-full text-xl md:text-2xl font-light border-none focus:ring-0 placeholder-gray-200 resize-none" placeholder="Describe a novel architecture..."></textarea>
      <div class="mt-4 md:mt-6 pt-4 md:pt-6 border-t border-gray-50 flex flex-col sm:flex-row justify-between items-center gap-4">
        <div id="statusLabel" class="text-xs md:text-sm text-gray-400 font-sans tracking-wide text-center sm:text-left">Ready for synthesis</div>
        <button onclick="generateModel()" id="btn" class="w-full sm:w-auto gold-bg text-white px-8 md:px-10 py-3 rounded-full hover:scale-105 transition-all shadow-lg font-semibold tracking-wide active:scale-95 text-sm md:text-base">
          Generate & Rank
        </button>
      </div>
    </div>

    <div class="equation-box rounded-xl p-4 md:p-6 mb-6 md:mb-8 text-center overflow-x-auto">
        <div class="text-[9px] uppercase tracking-widest text-gray-400 mb-2 font-sans">Ranking Algorithm: Min-Max Normalization</div>
        <div class="text-base md:text-lg text-gray-700 py-2">
            $$Score = \frac{1}{n} \sum_{i=1}^{n} \frac{x_i - Min_i}{Max_i - Min_i}$$
        </div>
        <div class="text-[10px] text-gray-400 mt-2 font-sans italic">
            Where \(x\) is accuracy, \(Min\) is the global floor, and \(Max\) is the record.
        </div>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-5 md:p-8 border border-gray-100 mb-6 md:mb-8">
        <button onclick="toggleDetails()" class="w-full flex items-center justify-between group">
          <h2 class="text-xl md:text-2xl font-light">Global Benchmarking Details</h2>
          <span id="toggleIcon" class="text-gray-400 group-hover:text-black transition-transform">â–¼</span>
        </button>
        <div id="detailsGrid" class="hidden mt-6 md:mt-8 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4 border-t border-gray-50 pt-6"></div>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-5 md:p-8 border border-gray-100">
      <div class="flex items-center justify-between mb-6 md:mb-8 border-b border-gray-50 pb-4">
        <h2 class="text-2xl md:text-3xl font-light">Leaderboard</h2>
        <div class="text-right">
          <div class="text-[9px] uppercase tracking-widest text-gray-400">Metric</div>
          <div class="text-[11px] md:text-sm font-bold gold-text uppercase">Normalized Score</div>
        </div>
      </div>
      <div id="leaderboardList" class="space-y-3 md:space-y-4"></div>
    </div>

    <div id="authModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center p-0 sm:p-6">
      <div class="bg-white rounded-t-3xl sm:rounded-2xl shadow-2xl p-6 md:p-8 max-w-md w-full border border-gray-100 pb-10 sm:pb-8">
        <div class="flex justify-between items-center mb-6">
          <h2 id="modalTitle" class="text-2xl md:text-3xl font-light">Login</h2>
          <button onclick="closeAuthModal()" class="text-gray-400 hover:text-black text-2xl px-2">&times;</button>
        </div>
        <div class="space-y-4">
          <div id="usernameWrapper" class="hidden">
            <input type="text" id="authUsername" placeholder="Architect Name" 
                   class="w-full p-3 md:p-4 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-[#D4AF37] outline-none mb-2">
          </div>
          <input type="email" id="authEmail" placeholder="Email" class="w-full p-3 md:p-4 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-[#D4AF37] outline-none">
          <input type="password" id="authPassword" placeholder="Password" class="w-full p-3 md:p-4 bg-gray-50 border border-gray-100 rounded-xl focus:ring-2 focus:ring-[#D4AF37] outline-none">
          
          <button id="mainAuthBtn" onclick="submitAuth()" class="w-full gold-bg text-white py-3 md:py-4 rounded-xl font-bold shadow-lg hover:brightness-110 transition-all text-sm md:text-base">Continue</button>
          
          <div class="relative my-4">
            <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-gray-100"></span></div>
            <div class="relative flex justify-center text-[10px] uppercase tracking-widest"><span class="bg-white px-2 text-gray-400 font-sans">Or</span></div>
          </div>

          <button onclick="signInWithGoogle()" class="w-full flex items-center justify-center gap-3 bg-white border border-gray-200 py-3 rounded-xl font-semibold shadow-sm hover:bg-gray-50 transition-all text-xs md:text-sm font-sans">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-4 h-4 md:w-5 md:h-5">
            Continue with Google
          </button>
          
          <p class="text-center text-xs md:text-sm text-gray-400 mt-4">
            <span id="toggleText">Don't have an account?</span> 
            <button onclick="toggleAuthMode()" id="toggleBtn" class="gold-text font-bold ml-1">Sign Up</button>
          </p>
        </div>
      </div>
    </div>
  </main>

  <script>
    let supabaseClient = null; 
    let currentUser = null;
    let lastGeneratedModel = null;
    let isSignUpMode = false;
    let detailsVisible = false;

    async function initSupabase() {
        try {
            const res = await fetch('/config');
            const config = await res.json();
            
            supabaseClient = supabase.createClient(config.supabase_url, config.supabase_anon_key);
            
            const { data: { session } } = await supabaseClient.auth.getSession();
            currentUser = session?.user ?? null;
            await checkUser();

            supabaseClient.auth.onAuthStateChange(async (event, session) => {
              currentUser = session?.user ?? null;
              await checkUser();
              if (currentUser) closeAuthModal();
              refreshLeaderboard();
            });
            
        } catch (err) {
            console.error("Initialization failed.", err);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initSupabase();
        refreshLeaderboard();
    });

    async function checkUser() {
      const authBtn = document.getElementById("authBtn");
      const mainHeader = document.getElementById("mainHeader");
      
      if (currentUser) {
        if (authBtn) authBtn.innerText = "Logout";
        const name = currentUser.user_metadata?.display_name || currentUser.user_metadata?.full_name || currentUser.email.split('@')[0];

        if (mainHeader) {
            mainHeader.innerHTML = `Hi <span class="gold-text">${name}</span>, prompt Omega to make your own ML Model.`;
        }
      } else {
        if (authBtn) authBtn.innerText = "Login";
        if (mainHeader) {
            mainHeader.innerText = "Please login to compete.";
        }
      }
    }

    async function handleAuth() {
      if (currentUser) {
        await supabaseClient.auth.signOut();
        currentUser = null;
        await checkUser();
        refreshLeaderboard();
      } else {
        openAuthModal();
      }
    }

    async function submitAuth() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const username = document.getElementById('authUsername').value;
      
      if (isSignUpMode) {
        const { error } = await supabaseClient.auth.signUp({
          email, password, options: { data: { display_name: username } }
        });
        if (error) alert(error.message);
        else alert("Verification email sent!");
      } else {
        const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
        if (error) alert(error.message);
      }
    }

    async function signInWithGoogle() {
      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: `${window.location.origin}/` }
      });
      if (error) alert(error.message);
    }

    function openAuthModal() { document.getElementById('authModal').classList.remove('hidden'); }
    function closeAuthModal() { document.getElementById('authModal').classList.add('hidden'); }
    function toggleAuthMode() {
      isSignUpMode = !isSignUpMode;
      const userWrapper = document.getElementById('usernameWrapper');
      document.getElementById('modalTitle').innerText = isSignUpMode ? "Sign Up" : "Login";
      document.getElementById('mainAuthBtn').innerText = isSignUpMode ? "Create Account" : "Continue";
      document.getElementById('toggleText').innerText = isSignUpMode ? "Already have an account?" : "Don't have an account?";
      document.getElementById('toggleBtn').innerText = isSignUpMode ? "Login" : "Sign Up";
      isSignUpMode ? userWrapper.classList.remove('hidden') : userWrapper.classList.add('hidden');
    }

    async function generateModel() {
      if (!currentUser) return openAuthModal();
      const prompt = document.getElementById('prompt').value;
      const btn = document.getElementById('btn');
      const status = document.getElementById('statusLabel');
      if (!prompt.trim()) return alert("Enter a description.");

      btn.disabled = true;
      btn.classList.add('opacity-50');
      status.innerText = "Synthesizing & Benchmarking...";

      try {
        const name = currentUser.user_metadata?.display_name || currentUser.email.split('@')[0];
        const response = await fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            description: prompt,
            user_id: currentUser.id,
            creator_name: name
          })
        });
        const data = await response.json();
        if (response.ok) {
          lastGeneratedModel = data;
          status.innerText = "Ranked successfully.";
          refreshLeaderboard();
        } else { throw new Error(data.detail); }
      } catch (err) { alert(err.message); status.innerText = "Error."; }
      finally { btn.disabled = false; btn.classList.remove('opacity-50'); }
    }

    async function refreshLeaderboard() {
      const list = document.getElementById("leaderboardList");
      try {
        const res = await fetch("/leaderboard");
        const data = await res.json();
        list.innerHTML = "";
        data.ranked_list.forEach((m, idx) => {
            const isCurrent = lastGeneratedModel && m.id === lastGeneratedModel.id;
            const isBaseline = m.user_prompt === 'benchmark' || m.is_baseline === true;
            const card = document.createElement("div");
            let bgColor = "bg-gray-50 border-gray-100 hover:border-gray-300";
            let textColor = "text-gray-300";
            let scoreColor = "gold-text";

            if (isBaseline) {
                bgColor = "bg-blue-50 border-blue-200 shadow-sm";
                textColor = "text-blue-400";
                scoreColor = "text-blue-600";
            } else if (isCurrent) {
                bgColor = "bg-yellow-50 border-[#D4AF37] shadow-md ring-1 ring-[#D4AF37]";
                textColor = "gold-text";
            }

            card.className = `w-full p-4 md:p-5 rounded-xl border transition-all cursor-pointer mb-3 ${bgColor}`;

            card.onclick = async () => {
                const isFlipped = card.classList.toggle('card-flipped');
                const summaryEl = card.querySelector('.summary-text');

                if (isFlipped && summaryEl.getAttribute('data-loaded') === 'false') {
                    summaryEl.innerText = "Synthesizing intuition...";
                    try {
                        const sRes = await fetch(`/summarize/${m.id}`);
                        const sData = await sRes.json();
                        summaryEl.innerText = sData.summary;
                        summaryEl.setAttribute('data-loaded', 'true');
                    } catch (err) {
                        summaryEl.innerText = "Mathematical summary unavailable.";
                    }
                }
            };

            card.innerHTML = `
                <div class="card-inner w-full min-h-[85px] relative">
                    <div class="card-front backface-hidden w-full p-4 md:p-5 rounded-xl border ${bgColor} flex items-center justify-between absolute inset-0 z-10 bg-inherit">
                        <div class="flex items-center justify-between w-full">
                            <div class="flex items-center gap-3 md:gap-5 min-w-0">
                                <span class="text-lg md:text-2xl font-bold ${textColor} w-7 flex-shrink-0">#${idx + 1}</span>
                                <div class="min-w-0">
                                    <div class="font-semibold text-sm md:text-lg truncate">${m.name}</div>
                                    <div class="text-[9px] uppercase tracking-widest text-gray-400 font-bold">${m.creator_name || 'System'}</div>
                                </div>
                            </div>
                            <div class="text-lg md:text-2xl font-bold ${scoreColor}">${(m.display_acc * 100).toFixed(2)}%</div>
                        </div>
                    </div>

                    <div class="card-back backface-hidden w-full p-4 md:p-5 rounded-xl border border-[#D4AF37]/30 bg-white absolute inset-0 flex flex-col justify-center">
                        <div class="text-[9px] uppercase tracking-widest gold-text mb-1 font-bold">Intuition</div>
                        <div class="summary-text text-[12px] md:text-[13px] leading-relaxed text-gray-600 italic font-serif" 
                             data-loaded="${m.summary ? 'true' : 'false'}">
                            ${m.summary || 'Click to reveal architecture details...'}
                        </div>
                    </div>
                </div>`;
            list.appendChild(card);
        });
      } catch (e) { console.error(e); }
    }

    async function toggleDetails() {
        const grid = document.getElementById("detailsGrid");
        const icon = document.getElementById("toggleIcon");
        detailsVisible = !detailsVisible;
        grid.classList.toggle("hidden", !detailsVisible);
        icon.style.transform = detailsVisible ? "rotate(180deg)" : "rotate(0deg)";
        if (detailsVisible) await refreshDatasetStats();
    }

    async function refreshDatasetStats() {
        const grid = document.getElementById("detailsGrid");
        try {
            const res = await fetch("/dataset-stats");
            const data = await res.json();
            grid.innerHTML = ""; 
            for (const [name, bounds] of Object.entries(data.stats)) {
                const card = document.createElement("div");
                card.className = "p-3 rounded-xl bg-gray-50 border border-gray-100";
                const maxPct = (bounds.max * 100).toFixed(1);
                card.innerHTML = `
                    <div class="text-[9px] uppercase text-gray-500 font-bold mb-1 truncate">${name}</div>
                    <div class="flex justify-between text-[10px] font-semibold">
                        <span class="text-red-400">Min: ${(bounds.min * 100).toFixed(1)}%</span>
                        <span class="text-green-600">Max: ${maxPct}%</span>
                    </div>
                    <div class="w-full bg-gray-200 h-1 mt-1 rounded-full overflow-hidden">
                        <div class="bg-green-500 h-full" style="width: ${maxPct}%"></div>
                    </div>`;
                grid.appendChild(card);
            }
        } catch (e) { grid.innerHTML = "Error loading stats."; }
    }
  </script>
</body>
</html>